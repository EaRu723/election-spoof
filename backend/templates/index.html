<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headline Spoofer</title>
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
    <script>
        async function fetchHeadlines() {
            try {
                const response = await fetch('/fetch-headlines');
                const data = await response.json();
                renderHeadlines(data.headlines);
                setupWebSocket();
            } catch (error) {
                console.error('Error fetching headlines:', error);
            }
        }

        function renderHeadlines(headlines) {
            const foxContainer = document.getElementById("fox-headlines");
            const cnnContainer = document.getElementById("cnn-headlines");
            
            foxContainer.innerHTML = '';
            cnnContainer.innerHTML = '';

            headlines.forEach(headline => {
                const headlineElement = createHeadlineElement(headline);
                if (headline.source.toLowerCase() === 'fox') {
                    foxContainer.appendChild(headlineElement);
                } else if (headline.source.toLowerCase() === 'cnn') {
                    cnnContainer.appendChild(headlineElement);
                }
            });
        }

        function createHeadlineElement(headline) {
            const div = document.createElement('div');
            div.className = 'headline';
            div.id = `headline-${headline.source}-${headline.index}`;
            div.innerHTML = `
                <p><strong>${headline.source.toUpperCase()}:</strong> ${headline.headline}</p>
                <div class="spoof-container">
                    <strong>Spoofed:</strong> <span class="spoofed-text">Loading...</span>
                    <div class="loading-animation"></div>
                </div>
            `;
            return div;
        }

        function setupWebSocket() {
            const ws = new WebSocket(`ws://${window.location.host}/ws/spoof-headlines`);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === "fetch_time") {
                    document.getElementById("fetch-time").textContent = data.fetch_time.toFixed(2);
                } else if (data.type === "spoof_time") {
                    document.getElementById("spoof-time").textContent = data.spoof_time.toFixed(2);
                } else {
                    updateSpoofedHeadline(data.source, data.index, data.spoofed_headline);
                }
            };

            ['open', 'close', 'error'].forEach(event => {
                ws[`on${event}`] = console.log.bind(console, `WebSocket ${event}`);
            });
        }

        function updateSpoofedHeadline(source, index, spoofedHeadline) {
            const headlineElement = document.getElementById(`headline-${source}-${index}`);
            if (headlineElement) {
                const spoofedTextElement = headlineElement.querySelector('.spoofed-text');
                const loadingAnimation = headlineElement.querySelector('.loading-animation');
                spoofedTextElement.textContent = spoofedHeadline;
                loadingAnimation.style.display = 'none';
            }
        }

        window.onload = fetchHeadlines;
    </script>
</head>
<body>
    <h1>The Circus</h1>
    <div id="timing-info" style="text-align: center; margin-top: 20px;">
        <p>Fetch time: <span id="fetch-time">-</span> seconds</p>
        <p>Spoof time: <span id="spoof-time">-</span> seconds</p>
    </div>
    <div id="headlines-wrapper">
        <div id="fox-column" class="column">
            <h2>Fox News</h2>
            <div id="fox-headlines"></div>
        </div>
        <div id="cnn-column" class="column">
            <h2>CNN</h2>
            <div id="cnn-headlines"></div>
        </div>
    </div>
</body>
</html>
